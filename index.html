<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClubConnect | Animated</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1149.0.min.js"></script>
    
    <style>
        /* --- Animation & Custom Styles --- */
        [data-page] { display: none; }
        [data-page="login"] { display: grid; }

        /* Page Transition Animations */
        .page-enter { animation: fadeIn 0.5s ease-in-out forwards; }
        .page-exit { animation: fadeOut 0.5s ease-in-out forwards; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }

        /* Modal Animations */
        #eventModal.flex { animation: fadeIn 0.3s ease-out; }
        #eventModal .modal-content { animation: slideInDown 0.3s ease-out; }
        #eventModal.modal-exit { animation: fadeOut 0.3s ease-out forwards; }
        #eventModal.modal-exit .modal-content { animation: slideOutUp 0.3s ease-out forwards; }

        @keyframes slideInDown {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes slideOutUp {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(-30px); opacity: 0; }
        }
        
        /* Event Card Animation */
        .event-card { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; opacity: 0; }
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Loading Spinner */
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Active Tab Style */
        .tab-active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            font-weight: 600;
        }
        
        /* Toast Notification Styles */
        #toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .toast {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            color: white;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s cubic-bezier(0.215, 0.61, 0.355, 1);
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast-success { background-color: #22c55e; } /* green-500 */
        .toast-error { background-color: #ef4444; } /* red-500 */
        
        /* Animated Gradient Background */
        .animated-gradient {
            background-size: 200% 200%;
            animation: gradient-animation 10s ease infinite;
        }
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div id="app">

        <main id="loginPage" data-page="login" class="min-h-screen grid md:grid-cols-2">
            <div class="hidden md:flex flex-col justify-center bg-gradient-to-br from-indigo-500 to-purple-600 text-white p-12 animated-gradient">
                <h1 class="text-5xl font-bold mb-4">ClubConnect</h1>
                <p class="text-xl text-indigo-200 mb-8">The centralized platform for all your college clubs.</p>
                <div class="space-y-6 text-indigo-100">
                    <div>
                        <h3 class="font-semibold text-lg mb-2">Discover & Engage:</h3>
                        <ul class="list-disc list-inside space-y-2">
                            <li>Find out what's happening on campus.</li>
                            <li>Never miss an event from your favorite clubs.</li>
                            <li>Promote your club's activities to the entire college.</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="flex flex-col justify-center items-center bg-white p-8 md:p-12">
                <div class="w-full max-w-md">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Welcome Back!</h2>
                    <form id="loginForm" class="space-y-6">
                        <div>
                            <label for="loginEmail" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="loginEmail" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition-shadow">
                        </div>
                        <div>
                            <label for="loginPassword" class="block text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="loginPassword" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition-shadow">
                        </div>
                        <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">
                            Log In
                        </button>
                    </form>
                    <p class="mt-6 text-center text-sm text-gray-600">
                        Donâ€™t have an account?
                        <a href="#" id="navigateToSignup" class="font-medium text-indigo-600 hover:text-indigo-500">Sign Up</a>
                    </p>
                </div>
            </div>
        </main>
        
        <main id="signupPage" data-page="signup" class="min-h-screen grid md:grid-cols-2">
            <div class="hidden md:flex flex-col justify-center bg-gradient-to-br from-indigo-500 to-purple-600 text-white p-12 animated-gradient">
                <h1 class="text-5xl font-bold mb-4">ClubConnect</h1>
                <p class="text-xl text-indigo-200 mb-8">Join the community and put your club on the map.</p>
                <div class="space-y-6 text-indigo-100">
                    <div>
                        <h3 class="font-semibold text-lg mb-2">Getting Started is Easy:</h3>
                        <ul class="list-disc list-inside space-y-2">
                            <li>Register your club in under a minute.</li>
                            <li>Start posting events immediately.</li>
                            <li>Reach a wider audience on campus.</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="flex flex-col justify-center items-center bg-white p-8 md:p-12">
                <div class="w-full max-w-md">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Create Your Account</h2>
                    <form id="signupForm" class="space-y-5">
                        <div>
                            <label for="signupClubName" class="block text-sm font-medium text-gray-700">Club Name</label>
                            <input type="text" id="signupClubName" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition-shadow">
                        </div>
                        <div>
                            <label for="signupEmail" class="block text-sm font-medium text-gray-700">Email Address</label>
                            <input type="email" id="signupEmail" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition-shadow">
                        </div>
                        <div>
                            <label for="signupPassword" class="block text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="signupPassword" required minlength="6" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition-shadow">
                        </div>
                        <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">
                            Sign Up
                        </button>
                    </form>
                    <p class="mt-6 text-center text-sm text-gray-600">
                        Already have an account?
                        <a href="#" id="navigateToLogin" class="font-medium text-indigo-600 hover:text-indigo-500">Log In</a>
                    </p>
                </div>
            </div>
        </main>
        
        <main id="eventsPage" data-page="events" class="bg-gray-50 min-h-screen">
            <header class="bg-white shadow-md sticky top-0 z-20">
                <nav class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                    <div>
                        <h1 id="welcomeClubName" class="text-2xl font-bold text-gray-800"></h1>
                        <p id="welcomeUserEmail" class="text-sm text-gray-500"></p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button id="openEventModalBtn" class="inline-flex items-center gap-2 justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 transition-transform transform hover:scale-105">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            Add Event
                        </button>
                        <button id="logoutButton" class="inline-flex items-center gap-2 justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" /></svg>
                            Logout
                        </button>
                    </div>
                </nav>
            </header>
            
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="mb-6 bg-white p-2 rounded-lg shadow-md flex space-x-2 max-w-lg mx-auto">
                    <button data-tab="upcoming" class="event-tab flex-1 text-center px-4 py-2 rounded-md transition-colors duration-200 text-gray-600 hover:bg-indigo-50">Upcoming</button>
                    <button data-tab="past" class="event-tab flex-1 text-center px-4 py-2 rounded-md transition-colors duration-200 text-gray-600 hover:bg-indigo-50">Past</button>
                    <button data-tab="my" class="event-tab flex-1 text-center px-4 py-2 rounded-md transition-colors duration-200 text-gray-600 hover:bg-indigo-50">My Events</button>
                </div>

                <div>
                    <h2 id="eventListHeader" class="text-2xl font-bold text-gray-900 mb-6 text-center">Upcoming Events</h2>
                    <div id="eventList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        </div>
                </div>
            </div>
        </main>

        <div id="eventModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
            <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-full overflow-y-auto">
                <div class="p-6 border-b flex justify-between items-center">
                    <h2 id="modalTitle" class="text-xl font-semibold text-gray-800">Post a New Event</h2>
                    <button id="closeEventModalBtn" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                </div>
                <form id="eventForm" class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <input type="hidden" id="eventId">
                    <div class="md:col-span-2">
                        <label for="eventName" class="block text-sm font-medium text-gray-700">Event Name</label>
                        <input type="text" id="eventName" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition-shadow">
                    </div>
                    <div class="md:col-span-2">
                        <label for="eventDescription" class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea id="eventDescription" rows="3" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition-shadow"></textarea>
                    </div>
                    <div>
                        <label for="eventDate" class="block text-sm font-medium text-gray-700">Event Date</label>
                        <input type="date" id="eventDate" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition-shadow">
                    </div>
                    <div>
                        <label for="eventImages" class="block text-sm font-medium text-gray-700">Event Images</label>
                        <input type="file" id="eventImages" multiple accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100 cursor-pointer">
                        <p class="text-xs text-gray-500 mt-1">For updates, selecting new images will replace old ones.</p>
                    </div>
                    <div class="md:col-span-2 text-right">
                        <button type="submit" class="inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 transition-transform transform hover:scale-105">
                            <span id="saveEventBtnText">Save Event</span>
                            <div id="saveEventSpinner" class="loading-spinner hidden"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
    class EventManager {
        constructor() {
            // --- AWS S3 Configuration (UNCHANGED) ---
            const AWS_CONFIG = {
                region: 'eu-north-1', 
                accessKeyId: 'AKIA36UVB2U4VSIHU36S',
                secretAccessKey: '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',
                bucketName: 'adityaccfa'
            };

            this.AWS_CONFIG = AWS_CONFIG;
            this.s3 = this.initializeS3();

            // --- State Management ---
            this.currentUser = null;
            this.allFetchedEvents = [];
            this.activeTab = 'upcoming';
            this.currentPage = 'login';
            
            // --- DOM Element Caching ---
            this.cacheDOMElements();
            this.bindEventListeners();
            this.showPage('login', true); // Initial load
        }

        cacheDOMElements() {
            this.dom = {
                pages: {
                    login: document.getElementById('loginPage'),
                    signup: document.getElementById('signupPage'),
                    events: document.getElementById('eventsPage')
                },
                loginForm: document.getElementById('loginForm'),
                signupForm: document.getElementById('signupForm'),
                navigateToSignup: document.getElementById('navigateToSignup'),
                navigateToLogin: document.getElementById('navigateToLogin'),
                logoutButton: document.getElementById('logoutButton'),
                eventList: document.getElementById('eventList'),
                welcomeClubName: document.getElementById('welcomeClubName'),
                welcomeUserEmail: document.getElementById('welcomeUserEmail'),
                eventModal: document.getElementById('eventModal'),
                openEventModalBtn: document.getElementById('openEventModalBtn'),
                closeEventModalBtn: document.getElementById('closeEventModalBtn'),
                eventForm: document.getElementById('eventForm'),
                modalTitle: document.getElementById('modalTitle'),
                eventTabs: document.querySelectorAll('.event-tab'),
                eventListHeader: document.getElementById('eventListHeader'),
                toastContainer: document.getElementById('toast-container'),
            };
        }

        initializeS3() {
            // NOTE: Storing credentials client-side is not recommended for production.
            // Consider using Amazon Cognito Identity Pools for secure, temporary credentials.
            if (this.AWS_CONFIG.accessKeyId && this.AWS_CONFIG.accessKeyId !== 'YOUR_IAM_USER_ACCESS_KEY_ID') {
                AWS.config.update({
                    region: this.AWS_CONFIG.region,
                    accessKeyId: this.AWS_CONFIG.accessKeyId,
                    secretAccessKey: this.AWS_CONFIG.secretAccessKey
                });
                return new AWS.S3({ apiVersion: '2006-03-01' });
            }
            console.warn("AWS S3 credentials are not configured.");
            return null;
        }

        bindEventListeners() {
            this.dom.navigateToSignup.addEventListener('click', (e) => { e.preventDefault(); this.showPage('signup'); });
            this.dom.navigateToLogin.addEventListener('click', (e) => { e.preventDefault(); this.showPage('login'); });
            this.dom.loginForm.addEventListener('submit', (e) => this.handleLogin(e));
            this.dom.signupForm.addEventListener('submit', (e) => this.handleSignup(e));
            this.dom.logoutButton.addEventListener('click', () => this.handleLogout());
            this.dom.openEventModalBtn.addEventListener('click', () => this.openEventModal());
            this.dom.closeEventModalBtn.addEventListener('click', () => this.closeEventModal());
            this.dom.eventModal.addEventListener('click', (e) => { if(e.target === this.dom.eventModal) this.closeEventModal(); });
            this.dom.eventForm.addEventListener('submit', (e) => this.handleSaveEvent(e));
            this.dom.eventTabs.forEach(tab => tab.addEventListener('click', (e) => this.handleTabClick(e)));
        }

        // --- UI & Animation Logic ---

        showPage(pageName, isInitialLoad = false) {
            if (this.currentPage === pageName && !isInitialLoad) return;

            const currentPageEl = this.dom.pages[this.currentPage];
            const nextPageEl = this.dom.pages[pageName];

            if (!nextPageEl) return;

            if (isInitialLoad) {
                Object.values(this.dom.pages).forEach(p => p.style.display = 'none');
                const isGridLayout = nextPageEl.classList.contains('grid');
                nextPageEl.style.display = isGridLayout ? 'grid' : 'block';
                this.currentPage = pageName;
                return;
            }

            if (currentPageEl) {
                currentPageEl.classList.add('page-exit');
                currentPageEl.addEventListener('animationend', () => {
                    currentPageEl.style.display = 'none';
                    currentPageEl.classList.remove('page-exit');
                }, { once: true });
            }

            setTimeout(() => {
                const isGridLayout = nextPageEl.classList.contains('grid');
                nextPageEl.style.display = isGridLayout ? 'grid' : 'block';
                nextPageEl.classList.add('page-enter');
                nextPageEl.addEventListener('animationend', () => {
                    nextPageEl.classList.remove('page-enter');
                }, { once: true });
                this.currentPage = pageName;
            }, 500); // Match animation duration
        }
        
        showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            this.dom.toastContainer.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 10); // Trigger transition
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove(), { once: true });
            }, 3000); // Hide after 3 seconds
        }

        openEventModal(eventId = null) {
            this.dom.eventForm.reset();
            document.getElementById('eventId').value = '';
            
            if (eventId) {
                const event = this.allFetchedEvents.find(e => e.id === eventId);
                if (event) {
                    this.dom.modalTitle.textContent = "Edit Event";
                    document.getElementById('eventId').value = event.id;
                    document.getElementById('eventName').value = event.eventName;
                    document.getElementById('eventDescription').value = event.description;
                    document.getElementById('eventDate').value = event.date;
                }
            } else {
                this.dom.modalTitle.textContent = "Post a New Event";
            }
            
            this.dom.eventModal.classList.remove('hidden', 'modal-exit');
            this.dom.eventModal.classList.add('flex');
        }
        
        closeEventModal() {
            this.dom.eventModal.classList.add('modal-exit');
            this.dom.eventModal.addEventListener('animationend', () => {
                this.dom.eventModal.classList.add('hidden');
                this.dom.eventModal.classList.remove('flex', 'modal-exit');
                this.dom.eventForm.reset();
            }, { once: true });
        }
        
        toggleSpinner(isLoading) {
            const btn = this.dom.eventForm.querySelector('button[type="submit"]');
            const btnText = document.getElementById('saveEventBtnText');
            const spinner = document.getElementById('saveEventSpinner');
            btn.disabled = isLoading;
            btnText.classList.toggle('hidden', isLoading);
            spinner.classList.toggle('hidden', !isLoading);
        }

        // --- Authentication (Logic UNCHANGED) ---
        handleSignup(e) {
            e.preventDefault();
            const clubName = document.getElementById('signupClubName').value.trim();
            const email = document.getElementById('signupEmail').value.trim().toLowerCase();
            const password = document.getElementById('signupPassword').value;
            if (!clubName || !email || password.length < 6) {
                return this.showToast('Please fill all fields. Password must be 6+ characters.', 'error');
            }
            const users = JSON.parse(localStorage.getItem('eventPlatformUsers')) || [];
            if (users.find(user => user.email === email)) {
                return this.showToast('An account with this email already exists.', 'error');
            }
            users.push({ clubName, email, password });
            localStorage.setItem('eventPlatformUsers', JSON.stringify(users));
            this.showToast('Signup successful! Please log in.', 'success');
            this.showPage('login');
        }

        handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;
            const users = JSON.parse(localStorage.getItem('eventPlatformUsers')) || [];
            const user = users.find(u => u.email === email && u.password === password);
            if (user) {
                this.currentUser = user;
                this.initializeAppForUser();
                this.showToast(`Welcome back, ${user.clubName}!`, 'success');
            } else {
                this.showToast('Invalid email or password.', 'error');
            }
        }
        
        handleLogout() {
            this.currentUser = null;
            this.allFetchedEvents = [];
            this.dom.eventList.innerHTML = '';
            this.showToast('You have been logged out.', 'success');
            this.showPage('login');
        }

        initializeAppForUser() {
            this.dom.welcomeClubName.textContent = `Welcome, ${this.currentUser.clubName}`;
            this.dom.welcomeUserEmail.textContent = this.currentUser.email;
            this.showPage('events');
            this.setActiveTab('upcoming');
            this.fetchAllEvents();
        }

        // --- Tab Logic ---
        handleTabClick(e) {
            this.setActiveTab(e.target.dataset.tab);
            this.renderEvents();
        }
        
        setActiveTab(tabName) {
            this.activeTab = tabName;
            const headers = { upcoming: "Upcoming Events", past: "Past Events", my: "My Events" };
            this.dom.eventListHeader.textContent = headers[tabName];
            this.dom.eventTabs.forEach(tab => tab.classList.toggle('tab-active', tab.dataset.tab === tabName));
        }

        // --- Event CRUD & S3 (Logic UNCHANGED) ---
        async handleSaveEvent(e) {
            e.preventDefault();
            if (!this.s3) return this.showToast("S3 is not configured.", 'error');
            
            const eventId = document.getElementById('eventId').value;
            const eventName = document.getElementById('eventName').value.trim();
            const eventDescription = document.getElementById('eventDescription').value.trim();
            const eventDate = document.getElementById('eventDate').value;
            const newImages = document.getElementById('eventImages').files;
            
            if (!eventName || !eventDescription || !eventDate) return this.showToast("Please fill all event details.", 'error');
            
            this.toggleSpinner(true);
            
            try {
                let existingEvent = null;
                let imageKeys = [];
                
                if (eventId) {
                    existingEvent = this.allFetchedEvents.find(e => e.id === eventId);
                    imageKeys = existingEvent.imageKeys || [];
                    if (newImages.length > 0 && imageKeys.length > 0) {
                        await this.deleteImagesFromS3(imageKeys);
                        imageKeys = [];
                    }
                }
                
                if (newImages.length > 0) {
                    const uploadedKeys = await this.uploadImagesToS3(newImages, eventName);
                    imageKeys.push(...uploadedKeys);
                }

                const eventData = {
                    id: eventId || `evt_${Date.now()}`,
                    clubName: this.currentUser.clubName,
                    eventName,
                    description: eventDescription,
                    date: eventDate,
                    imageKeys,
                    postedBy: this.currentUser.email,
                };

                if (eventId) {
                    const index = this.allFetchedEvents.findIndex(e => e.id === eventId);
                    this.allFetchedEvents[index] = eventData;
                } else {
                    this.allFetchedEvents.push(eventData);
                }

                await this.updateEventsOnS3();
                this.showToast(`Event ${eventId ? 'updated' : 'created'} successfully!`, 'success');
                this.closeEventModal();
                this.renderEvents();

            } catch (error) {
                console.error("Error saving event:", error);
                this.showToast("Failed to save event.", 'error');
            } finally {
                this.toggleSpinner(false);
            }
        }

        async handleDeleteClick(eventId) {
            if (!confirm("Are you sure you want to delete this event? This action cannot be undone.")) return;
            
            try {
                const eventToDelete = this.allFetchedEvents.find(e => e.id === eventId);
                
                if (eventToDelete?.imageKeys?.length > 0) {
                    await this.deleteImagesFromS3(eventToDelete.imageKeys);
                }

                this.allFetchedEvents = this.allFetchedEvents.filter(e => e.id !== eventId);
                await this.updateEventsOnS3();
                
                this.showToast("Event deleted successfully.", 'success');
                this.renderEvents();

            } catch (error) {
                console.error("Error deleting event:", error);
                this.showToast("Failed to delete event.", 'error');
            }
        }

        async fetchAllEvents() {
            if (!this.s3) {
                this.dom.eventList.innerHTML = `<p class="col-span-full text-center text-red-500">S3 is not configured.</p>`;
                return;
            }
            this.dom.eventList.innerHTML = `<p class="col-span-full text-center text-gray-500">Fetching events...</p>`;
            try {
                const data = await this.s3.getObject({ Bucket: this.AWS_CONFIG.bucketName, Key: 'events.json' }).promise();
                this.allFetchedEvents = JSON.parse(data.Body.toString('utf-8'));
            } catch (err) {
                if (err.code === 'NoSuchKey') {
                   this.allFetchedEvents = [];
                   this.showToast('No events found. Create the first one!', 'success');
                } else {
                   console.error("Error fetching events:", err);
                   this.dom.eventList.innerHTML = `<p class="col-span-full text-center text-red-500">Failed to load events.</p>`;
                }
            } finally {
                this.renderEvents();
            }
        }

        renderEvents() {
            let filteredEvents = [];
            const today = new Date().setHours(0, 0, 0, 0);

            if (this.activeTab === 'upcoming') {
                filteredEvents = this.allFetchedEvents.filter(event => new Date(event.date).setHours(0,0,0,0) >= today);
            } else if (this.activeTab === 'past') {
                filteredEvents = this.allFetchedEvents.filter(event => new Date(event.date).setHours(0,0,0,0) < today);
            } else if (this.activeTab === 'my') {
                filteredEvents = this.allFetchedEvents.filter(event => event.postedBy === this.currentUser.email);
            }
            
            if (filteredEvents.length === 0) {
                this.dom.eventList.innerHTML = `<p class="col-span-full text-center text-gray-600">No events found in this category.</p>`;
                return;
            }
            
            filteredEvents.sort((a, b) => new Date(b.date) - new Date(a.date));
            this.dom.eventList.innerHTML = filteredEvents.map(event => this.createEventCard(event)).join('');
            
            // Staggered animation for cards
            document.querySelectorAll('.event-card').forEach((card, index) => {
                setTimeout(() => { card.style.opacity = '1'; card.style.transform = 'scale(1)'; }, index * 100);
            });
        }

        createEventCard(event) {
            const imageUrls = (event.imageKeys || []).map(key => this.s3.getSignedUrl('getObject', { Bucket: this.AWS_CONFIG.bucketName, Key: key, Expires: 3600 }));
            const imagesHtml = imageUrls.length > 0 ?
                `<div class="mt-4 grid grid-cols-2 gap-2">
                    ${imageUrls.slice(0, 4).map(url => `<img src="${url}" alt="Event image" class="w-full h-24 object-cover rounded-md">`).join('')}
                </div>` : '';
            
            const actionButtons = this.activeTab === 'my' ? `
                <div class="mt-4 pt-4 border-t border-gray-200 flex space-x-2">
                    <button onclick="app.openEventModal('${event.id}')" class="flex-1 text-sm bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition-colors">Edit</button>
                    <button onclick="app.handleDeleteClick('${event.id}')" class="flex-1 text-sm bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 transition-colors">Delete</button>
                </div>` : '';

            return `
                <div class="event-card bg-white p-6 rounded-lg shadow-lg flex flex-col transition-transform transform hover:-translate-y-1">
                    <div class="flex-grow">
                        <div class="flex justify-between items-start">
                            <h3 class="text-xl font-bold text-gray-900">${event.eventName}</h3>
                            <p class="text-sm text-gray-600 font-semibold flex-shrink-0 ml-2">${new Date(event.date).toLocaleDateString()}</p>
                        </div>
                        <p class="text-sm font-medium text-purple-700 mt-1">${event.clubName}</p>
                        <p class="text-gray-700 mt-2 text-sm whitespace-pre-wrap">${event.description}</p>
                        ${imagesHtml}
                    </div>
                    ${actionButtons}
                </div>`;
        }

        // --- S3 Helpers (Logic UNCHANGED) ---
        async uploadImagesToS3(files, eventName) {
            const safeClubName = this.currentUser.clubName.replace(/\s+/g, '-').toLowerCase();
            const safeEventName = eventName.replace(/\s+/g, '-').toLowerCase();
            const uploadPromises = Array.from(files).map((file, i) => {
                const key = `images/${safeClubName}_${safeEventName}_${Date.now()}_${i}.${file.name.split('.').pop()}`;
                return this.s3.upload({ Bucket: this.AWS_CONFIG.bucketName, Key: key, Body: file, ContentType: file.type }).promise();
            });
            const results = await Promise.all(uploadPromises);
            return results.map(result => result.Key);
        }

        async deleteImagesFromS3(keys) {
            if (!keys || keys.length === 0) return;
            const objects = keys.map(key => ({ Key: key }));
            await this.s3.deleteObjects({ Bucket: this.AWS_CONFIG.bucketName, Delete: { Objects: objects } }).promise();
        }
        
        async updateEventsOnS3() {
            await this.s3.putObject({
                Bucket: this.AWS_CONFIG.bucketName,
                Key: 'events.json',
                Body: JSON.stringify(this.allFetchedEvents, null, 2),
                ContentType: 'application/json'
            }).promise();
        }
    }

    // Expose the app instance to the global window object
    // for inline `onclick` attributes.
    window.app = new EventManager();
    </script>
</body>
</html>
